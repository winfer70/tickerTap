# TickerTap nginx configuration
# ─────────────────────────────────────────────────────────────────────────────
# Two server blocks:
#   1. Port 80  — permanent redirect to HTTPS (no content served over HTTP)
#   2. Port 443 — HTTPS with TLS 1.2/1.3, HSTS, and full security headers
#
# Certificate management (Let's Encrypt / certbot):
#   sudo certbot --nginx -d ticker-tap.com -d www.ticker-tap.com
# Certbot will update the ssl_certificate / ssl_certificate_key paths below.
#
# To test config:   sudo nginx -t
# To reload:        sudo nginx -s reload
# ─────────────────────────────────────────────────────────────────────────────


# ── 1. HTTP → HTTPS permanent redirect ───────────────────────────────────────
server {
    listen 80;
    listen [::]:80;
    server_name ticker-tap.com www.ticker-tap.com;

    # Allow Let's Encrypt ACME challenge through before redirecting.
    location /.well-known/acme-challenge/ {
        root /var/www/certbot;
    }

    # Redirect everything else to HTTPS with a 301.
    location / {
        return 301 https://$host$request_uri;
    }
}


# ── 2. HTTPS — primary serving block ─────────────────────────────────────────
server {
    listen 443 ssl http2;
    listen [::]:443 ssl http2;
    server_name ticker-tap.com www.ticker-tap.com;

    root  /srv/frontend;
    index index.html;

    # ── TLS certificates (managed by certbot) ────────────────────────────────
    # Update these paths after running certbot for your domain.
    ssl_certificate     /etc/letsencrypt/live/ticker-tap.com/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/ticker-tap.com/privkey.pem;

    # ── TLS protocol and cipher hardening ────────────────────────────────────
    ssl_protocols             TLSv1.2 TLSv1.3;
    ssl_ciphers               ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-CHACHA20-POLY1305:ECDHE-RSA-CHACHA20-POLY1305:DHE-RSA-AES128-GCM-SHA256;
    ssl_prefer_server_ciphers off;   # Let TLS 1.3 negotiate freely
    ssl_session_cache         shared:SSL:10m;
    ssl_session_timeout       1d;
    ssl_session_tickets       off;   # Disable for forward secrecy
    ssl_stapling              on;
    ssl_stapling_verify       on;

    # ── Security response headers ─────────────────────────────────────────────
    # HSTS: instruct browsers to enforce HTTPS for 1 year (+ subdomains + preload).
    # Remove includeSubDomains if you host non-HTTPS subdomains.
    add_header Strict-Transport-Security "max-age=31536000; includeSubDomains; preload" always;

    # Prevent clickjacking — the SPA does not need to be embedded in iframes.
    add_header X-Frame-Options "DENY" always;

    # Prevent MIME-type sniffing (XSS vector in older browsers).
    add_header X-Content-Type-Options "nosniff" always;

    # Referrer policy — send full URL only to same origin, stripped elsewhere.
    add_header Referrer-Policy "strict-origin-when-cross-origin" always;

    # Permissions policy — disable APIs this app does not use.
    add_header Permissions-Policy "camera=(), microphone=(), geolocation=(), payment=()" always;

    # Content Security Policy
    # Adjust script-src / style-src if you add external CDN dependencies.
    add_header Content-Security-Policy "
        default-src 'self';
        script-src  'self';
        style-src   'self' 'unsafe-inline';
        img-src     'self' data: https:;
        font-src    'self';
        connect-src 'self' https://query2.finance.yahoo.com;
        frame-ancestors 'none';
        base-uri    'self';
        form-action 'self';
    " always;

    # ── Client request limits ─────────────────────────────────────────────────
    # Reject bodies larger than 1 MB to prevent DoS via oversized payloads.
    client_max_body_size 1m;

    # ── Proxy timeouts ────────────────────────────────────────────────────────
    proxy_connect_timeout 10s;
    proxy_send_timeout    30s;
    proxy_read_timeout    60s;

    # ── API routes → FastAPI backend ──────────────────────────────────────────
    location ~ ^/(auth|accounts|transactions|holdings|orders|portfolio|market|admin|health)(/|$) {
        proxy_pass         http://127.0.0.1:8000;
        proxy_http_version 1.1;
        proxy_set_header   Host              $host;
        proxy_set_header   X-Real-IP         $remote_addr;
        proxy_set_header   X-Forwarded-For   $proxy_add_x_forwarded_for;
        proxy_set_header   X-Forwarded-Proto $scheme;
    }

    # ── Static assets (JS/CSS chunks with content hash) ──────────────────────
    location /assets/ {
        expires 1y;
        add_header Cache-Control "public, immutable";
    }

    # ── SPA fallback — all other paths serve index.html ──────────────────────
    location / {
        try_files $uri $uri/ /index.html;
    }
}
